<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OVERLAP — Solana Holder Scanner</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #080b0f;
    --surface: #0e1318;
    --border: #1a2330;
    --accent: #00ff88;
    --accent2: #0066ff;
    --danger: #ff3366;
    --text: #e8edf2;
    --muted: #4a5568;
    --mono: 'Space Mono', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 0 auto;
    padding: 40px 24px 80px;
  }

  /* Header */
  header {
    text-align: center;
    margin-bottom: 56px;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(64px, 12vw, 110px);
    letter-spacing: 8px;
    line-height: 1;
    background: linear-gradient(135deg, var(--accent) 0%, #00ccff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: pulse-glow 3s ease-in-out infinite;
  }

  @keyframes pulse-glow {
    0%, 100% { filter: drop-shadow(0 0 20px rgba(0,255,136,0.3)); }
    50% { filter: drop-shadow(0 0 40px rgba(0,255,136,0.6)); }
  }

  .tagline {
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 4px;
    color: var(--muted);
    text-transform: uppercase;
    margin-top: 8px;
  }

  /* Card */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px;
    margin-bottom: 16px;
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0.4;
  }

  .card-title {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 20px;
  }

  /* Coin inputs */
  .coins-list { display: flex; flex-direction: column; gap: 12px; }

  .coin-row {
    display: grid;
    grid-template-columns: 130px 1fr 36px;
    gap: 10px;
    align-items: center;
    animation: slide-in 0.3s ease;
  }

  @keyframes slide-in {
    from { opacity: 0; transform: translateY(-8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .coin-index {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
  }

  input {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 12px;
    padding: 10px 14px;
    width: 100%;
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
  }

  input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,255,136,0.08);
  }

  input::placeholder { color: var(--muted); }

  .label-input { color: var(--accent); }

  .remove-btn {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    font-size: 16px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .remove-btn:hover { border-color: var(--danger); color: var(--danger); }

  /* Add coin button */
  .add-coin-btn {
    background: none;
    border: 1px dashed var(--border);
    border-radius: 8px;
    color: var(--muted);
    cursor: pointer;
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 2px;
    padding: 10px;
    width: 100%;
    margin-top: 10px;
    transition: all 0.2s;
    text-transform: uppercase;
  }

  .add-coin-btn:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(0,255,136,0.03);
  }

  /* Filter row */
  .filter-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  .field { display: flex; flex-direction: column; gap: 8px; }
  .field label {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }

  /* Scan button */
  .scan-btn {
    width: 100%;
    padding: 16px;
    background: linear-gradient(135deg, var(--accent), #00ccff);
    border: none;
    border-radius: 10px;
    color: #000;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 4px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }

  .scan-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 30px rgba(0,255,136,0.3); }
  .scan-btn:active { transform: translateY(0); }
  .scan-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

  /* Status / Loading */
  .status {
    display: none;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--accent);
    text-align: center;
    padding: 20px;
    letter-spacing: 1px;
  }

  .status.visible { display: block; }

  .spinner {
    display: inline-block;
    width: 12px; height: 12px;
    border: 2px solid rgba(0,255,136,0.2);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-right: 8px;
    vertical-align: middle;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  /* Results */
  .results { display: none; }
  .results.visible { display: block; }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
    flex-wrap: gap;
    gap: 12px;
  }

  .results-stats {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
  }

  .results-stats span { color: var(--accent); font-weight: 700; }

  .export-btn {
    background: none;
    border: 1px solid var(--accent);
    border-radius: 6px;
    color: var(--accent);
    cursor: pointer;
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 2px;
    padding: 8px 16px;
    text-transform: uppercase;
    transition: all 0.2s;
  }

  .export-btn:hover { background: rgba(0,255,136,0.1); }

  /* Table */
  .table-wrap { overflow-x: auto; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-family: var(--mono);
    font-size: 11px;
  }

  th {
    color: var(--muted);
    font-size: 9px;
    letter-spacing: 2px;
    text-transform: uppercase;
    padding: 10px 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }

  td {
    padding: 10px 12px;
    border-bottom: 1px solid rgba(26,35,48,0.6);
    vertical-align: middle;
  }

  tr:hover td { background: rgba(0,255,136,0.02); }

  .wallet-cell { 
    font-size: 11px;
    color: var(--text);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .wallet-addr {
    cursor: pointer;
    transition: color 0.2s;
  }
  .wallet-addr:hover { color: var(--accent); }

  .known-badge {
    background: rgba(0,255,136,0.1);
    border: 1px solid rgba(0,255,136,0.3);
    border-radius: 4px;
    color: var(--accent);
    font-size: 9px;
    letter-spacing: 1px;
    padding: 2px 6px;
    white-space: nowrap;
  }

  .pct-cell { color: var(--accent2); }
  .pct-high { color: var(--accent); }
  .holding-badge {
    background: rgba(0,255,136,0.1);
    border: 1px solid rgba(0,255,136,0.25);
    border-radius: 3px;
    color: var(--accent);
    font-size: 8px;
    letter-spacing: 1px;
    padding: 1px 5px;
    margin-left: 4px;
    vertical-align: middle;
  }
  .exited-badge {
    background: rgba(255,51,102,0.1);
    border: 1px solid rgba(255,51,102,0.25);
    border-radius: 3px;
    color: var(--danger);
    font-size: 8px;
    letter-spacing: 1px;
    padding: 1px 5px;
    margin-left: 4px;
    vertical-align: middle;
  }
  .hist-note {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    text-align: center;
    padding: 8px;
    margin-bottom: 12px;
    background: rgba(0,102,255,0.05);
    border: 1px solid rgba(0,102,255,0.15);
    border-radius: 6px;
  }
  .bal-cell { color: var(--muted); }

  .no-results {
    text-align: center;
    padding: 48px;
    font-family: var(--mono);
    font-size: 12px;
    color: var(--muted);
  }

  .error-msg {
    background: rgba(255,51,102,0.08);
    border: 1px solid rgba(255,51,102,0.3);
    border-radius: 8px;
    color: var(--danger);
    font-family: var(--mono);
    font-size: 12px;
    padding: 16px;
    margin-top: 12px;
    display: none;
  }
  .error-msg.visible { display: block; }

  /* Wallet Manager */
  .tab-bar {
    display: flex;
    gap: 4px;
    margin-bottom: -1px;
    position: relative;
    z-index: 1;
  }

  .tab {
    background: none;
    border: 1px solid var(--border);
    border-bottom: none;
    border-radius: 8px 8px 0 0;
    color: var(--muted);
    cursor: pointer;
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 2px;
    padding: 8px 18px;
    text-transform: uppercase;
    transition: all 0.2s;
  }

  .tab.active {
    background: var(--surface);
    color: var(--accent);
    border-color: var(--border);
  }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .wallet-add-row {
    display: grid;
    grid-template-columns: 1fr 180px 80px;
    gap: 10px;
    margin-bottom: 20px;
  }

  .add-wallet-btn {
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: #000;
    cursor: pointer;
    font-family: var(--mono);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 1px;
    padding: 10px;
    transition: all 0.2s;
  }

  .add-wallet-btn:hover { opacity: 0.85; }
  .add-wallet-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .wallet-list-header {
    display: grid;
    grid-template-columns: 1fr 200px 36px;
    gap: 10px;
    padding: 0 4px 8px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 8px;
  }

  .wallet-list-header span {
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--muted);
    text-transform: uppercase;
  }

  .wallet-item {
    display: grid;
    grid-template-columns: 1fr 200px 36px;
    gap: 10px;
    align-items: center;
    padding: 8px 4px;
    border-bottom: 1px solid rgba(26,35,48,0.5);
    animation: slide-in 0.2s ease;
  }

  .wallet-item:hover { background: rgba(0,255,136,0.02); }

  .wallet-item-addr {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--text);
  }

  .wallet-item-label {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--accent);
  }

  .wallet-count {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    margin-bottom: 16px;
  }

  .wallet-count span { color: var(--accent); }

  .sync-indicator {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 1px;
    color: var(--muted);
    margin-left: 12px;
  }

  .sync-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: var(--muted);
    transition: background 0.3s;
  }

  .sync-dot.synced { background: var(--accent); }
  .sync-dot.syncing { background: #ffaa00; animation: spin 1s linear infinite; }

  .empty-wallets {
    text-align: center;
    padding: 32px;
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
  }

  /* Saved Scans */
  .scan-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 8px;
    border-bottom: 1px solid rgba(26,35,48,0.5);
    gap: 12px;
    animation: slide-in 0.2s ease;
  }

  .scan-item:hover { background: rgba(0,255,136,0.02); cursor: pointer; }

  .scan-item-info { flex: 1; min-width: 0; }

  .scan-item-name {
    font-family: var(--mono);
    font-size: 12px;
    color: var(--accent);
    margin-bottom: 4px;
  }

  .scan-item-meta {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .scan-item-actions { display: flex; gap: 6px; flex-shrink: 0; }

  .load-btn {
    background: rgba(0,255,136,0.1);
    border: 1px solid rgba(0,255,136,0.3);
    border-radius: 6px;
    color: var(--accent);
    cursor: pointer;
    font-family: var(--mono);
    font-size: 9px;
    letter-spacing: 1px;
    padding: 6px 12px;
    text-transform: uppercase;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .load-btn:hover { background: rgba(0,255,136,0.2); }

  .save-scan-row {
    display: grid;
    grid-template-columns: 1fr 100px;
    gap: 10px;
    margin-bottom: 20px;
  }

  /* Confirm delete overlay */
  .confirm-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    backdrop-filter: blur(4px);
  }

  .confirm-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 28px 32px;
    max-width: 340px;
    width: 90%;
    text-align: center;
  }

  .confirm-box h3 {
    font-family: var(--mono);
    font-size: 13px;
    color: var(--danger);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 10px;
  }

  .confirm-box p {
    font-family: var(--mono);
    font-size: 11px;
    color: var(--muted);
    margin-bottom: 20px;
    line-height: 1.6;
  }

  .confirm-btns { display: flex; gap: 10px; justify-content: center; }

  .confirm-yes {
    background: var(--danger);
    border: none;
    border-radius: 6px;
    color: #fff;
    cursor: pointer;
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 1px;
    padding: 10px 20px;
    transition: opacity 0.2s;
  }

  .confirm-yes:hover { opacity: 0.85; }

  .confirm-no {
    background: none;
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--muted);
    cursor: pointer;
    font-family: var(--mono);
    font-size: 11px;
    letter-spacing: 1px;
    padding: 10px 20px;
    transition: all 0.2s;
  }

  .confirm-no:hover { border-color: var(--text); color: var(--text); }
  footer {
    text-align: center;
    margin-top: 48px;
    font-family: var(--mono);
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 2px;
  }

  /* Password Gate */
  .pwd-overlay {
    position: fixed;
    inset: 0;
    background: var(--bg);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 999;
  }

  .pwd-box {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 48px 40px;
    max-width: 360px;
    width: 90%;
    text-align: center;
    position: relative;
    overflow: hidden;
  }

  .pwd-box::before {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
  }

  .pwd-logo {
    font-family: "Bebas Neue", sans-serif;
    font-size: 52px;
    letter-spacing: 6px;
    background: linear-gradient(135deg, var(--accent) 0%, #00ccff 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 8px;
  }

  .pwd-sub {
    font-family: var(--mono);
    font-size: 10px;
    letter-spacing: 3px;
    color: var(--muted);
    text-transform: uppercase;
    margin-bottom: 32px;
  }

  .pwd-input-wrap { position: relative; margin-bottom: 12px; }

  .pwd-input {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 18px;
    letter-spacing: 6px;
    padding: 14px 18px;
    text-align: center;
    width: 100%;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .pwd-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(0,255,136,0.08);
  }

  .pwd-input.error {
    border-color: var(--danger);
    animation: shake 0.3s ease;
  }

  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }

  .pwd-btn {
    width: 100%;
    padding: 14px;
    background: linear-gradient(135deg, var(--accent), #00ccff);
    border: none;
    border-radius: 8px;
    color: #000;
    font-family: "Bebas Neue", sans-serif;
    font-size: 18px;
    letter-spacing: 3px;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 4px;
  }

  .pwd-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(0,255,136,0.25); }

  .pwd-error {
    font-family: var(--mono);
    font-size: 10px;
    color: var(--danger);
    letter-spacing: 1px;
    margin-top: 10px;
    min-height: 16px;
  }

</style>
</head>
<body>

<!-- Password Gate -->
<div class="pwd-overlay" id="pwdOverlay">
  <div class="pwd-box">
    <div class="pwd-logo">OVERLAP</div>
    <div class="pwd-sub">Private Access</div>
    <div class="pwd-input-wrap">
      <input class="pwd-input" id="pwdInput" type="password" placeholder="••••••" maxlength="32" autocomplete="off">
    </div>
    <button class="pwd-btn" onclick="checkPassword()">ENTER</button>
    <div class="pwd-error" id="pwdError"></div>
  </div>
</div>

<div class="container">

  <header>
    <div class="logo">OVERLAP</div>
    <div class="tagline">Solana Multi-Coin Holder Scanner</div>
  </header>

  <!-- Input card -->
  <div class="card">
    <div class="card-title">// Coins to Scan</div>
    <div class="coins-list" id="coinsList"></div>
    <button class="add-coin-btn" onclick="addCoin()">+ Add Another Coin</button>
  </div>

  <!-- Filters card -->
  <div class="card">
    <div class="card-title">// Filters</div>
    <div class="filter-row">
      <div class="field">
        <label>Min % of Supply (per coin)</label>
        <input type="number" id="minPct" placeholder="e.g. 0.01" step="0.001" min="0" value="">
      </div>
      <div class="field">
        <label>Max Results to Show</label>
        <input type="number" id="maxResults" placeholder="e.g. 100" min="1" value="100">
      </div>
    </div>
  </div>

  <!-- Wallet Manager -->
  <div style="margin-bottom:16px;">
    <div class="tab-bar">
      <button class="tab active" onclick="switchTab('scan')">Scan</button>
      <button class="tab" onclick="switchTab('wallets')">
        Tracked Wallets
        <span id="walletTabCount" style="margin-left:6px;background:rgba(0,255,136,0.15);color:var(--accent);border-radius:4px;padding:1px 6px;font-size:9px;"></span>
      </button>
      <button class="tab" onclick="switchTab('saved')">
        Saved Scans
        <span id="savedTabCount" style="margin-left:6px;background:rgba(0,102,255,0.15);color:var(--accent2);border-radius:4px;padding:1px 6px;font-size:9px;"></span>
      </button>
    </div>

    <div class="card" style="border-radius:0 12px 12px 12px;margin-bottom:0;">

      <!-- Scan tab -->
      <div class="tab-content active" id="tab-scan">
        <div style="color:var(--muted);font-family:var(--mono);font-size:10px;letter-spacing:1px;">
          Ready to scan. Configure coins and filters above.
        </div>
      </div>

      <!-- Wallets tab -->
      <div class="tab-content" id="tab-wallets">
        <div style="display:flex;align-items:center;margin-bottom:16px;">
          <div class="card-title" style="margin-bottom:0;">// Global Wallet List</div>
          <div class="sync-indicator">
            <div class="sync-dot" id="syncDot"></div>
            <span id="syncLabel">loading...</span>
          </div>
        </div>

        <div class="wallet-add-row">
          <input id="newWalletAddr" placeholder="Wallet address (public key)" style="font-size:11px;">
          <input id="newWalletLabel" placeholder="Label (e.g. gorilla)" style="font-size:11px;color:var(--accent);">
          <button class="add-wallet-btn" id="addWalletBtn" onclick="addTrackedWallet()">ADD</button>
        </div>

        <div class="wallet-count" id="walletCount"></div>

        <div class="wallet-list-header">
          <span>Address</span>
          <span>Label</span>
          <span></span>
        </div>

        <div id="walletListEl">
          <div class="empty-wallets">Loading wallets...</div>
        </div>
      </div>

      <!-- Saved Scans tab -->
      <div class="tab-content" id="tab-saved">
        <div class="card-title">// Saved Scans</div>
        <div id="savedScansList">
          <div class="empty-wallets">No saved scans yet. Run a scan and hit Save.</div>
        </div>
      </div>

    </div>
  </div>

  <!-- Confirm delete overlay -->
  <div class="confirm-overlay" id="confirmOverlay" style="display:none;">
    <div class="confirm-box">
      <h3>Delete Scan?</h3>
      <p id="confirmMsg">This will permanently delete this scan for everyone.</p>
      <div class="confirm-btns">
        <button class="confirm-yes" id="confirmYesBtn">Delete</button>
        <button class="confirm-no" onclick="closeConfirm()">Cancel</button>
      </div>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
  <button class="scan-btn" id="scanBtn" onclick="runScan()">SCAN HOLDERS</button>
  <button class="scan-btn" id="histBtn" onclick="runHistoricalScan()" style="background:linear-gradient(135deg,#0066ff,#00ccff);">SCAN HISTORICAL</button>
</div>

  <div class="error-msg" id="errorMsg"></div>
  <div class="status" id="status"></div>

  <!-- Results -->
  <div class="results card" id="results" style="margin-top:16px;">
    <div class="results-header">
      <div class="results-stats" id="resultsStats"></div>
      <div style="display:flex;gap:8px;">
        <button class="export-btn" onclick="saveScan()" style="border-color:var(--accent2);color:var(--accent2);">✦ Save Scan</button>
        <button class="export-btn" onclick="exportCSV()">↓ Export CSV</button>
      </div>
    </div>
    <div class="table-wrap">
      <table id="resultsTable">
        <thead id="tableHead"></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <footer>OVERLAP — FREE · POWERED BY HELIUS</footer>
</div>

<script type="module">
const HELIUS_KEY = '358632a3-a824-492b-9e53-1d147b6e850f';
const HELIUS_RPC = `https://mainnet.helius-rpc.com/?api-key=${HELIUS_KEY}`;

// Built-in known wallets (base list)
const TRACKED_BASE = {
  "BM9CcyErJcu2mjrFvUsRRrD3snGeHDDVirJLvL6EjvMN":"idk","FCHSbVkVDRn3MJ96X2uzbvNkXuSQgQG6xev7yNZjuy7Y":"pump cabal 1","6Ut9MfDtGkTswtVoeQe863A6YKVsSJLTCgjRxFhDpump":"gorilla (merge)","8ckGSZMUQ1iGXogpaaXr115mV9WpnSepoe6qAWwc9gKH":"gorilla 24/01","8k2AVeW1g2rS87obcjSXJu3xC436kcLG6tktDjBCXiPj":"gorilla 26/01","vvaMq5tmzavtijZq5YroBLYBFTjuTonpiBAPqZJjUkL":"gorilla 26/12/25","2wZihhxUA3xujwXvHvSCHY1mtw4F3VPY7JHEtWkDCJkh":"gorilla 17/11/25 ded","f9rQW46Rt3hnjzHeBzkkQGW3cz3d4HZj3TFAxJquskE":"gorilla 15/12/25","ArhXsfkKkPtEVNEvequQSnX7oa7M4yVsUWtQZ3QFJBwk":"gorilla 25/01 2","EpYw97QExaxBybUGroRRkCpmXesYzVN2YFSXuCvSneQ6":"gorilla 25/01","49cGMoUsNx7gpKGsbXTeyezAGSoqj1zLgHMPhfGskdqT":"gorilla 04/02 ded","5QAFBi8ccDj3yCqmtpbD9oigCVfHm635H9YKGD1qAV18":"gorilla 21/02 2 ded","6vtS9fH1eZ7YNTk6sQ92icwFBNCBquf5gMkT3uYmpD8B":"gorilla 21/02 ded","3Cx88XZgEx7Vecw282A9dmmzuA6z9JgESsP2VPg433y7":"gorilla 21/02 6","J5cVZfGdwRkYeWCfaf7tSySnVnwoyaknrFxqiAveBZqN":"gorilla 21/02 5","7TomTWrZXZgqKbUCTRm8WCkxKpzAj69h3KdVbErWiKzy":"gorilla 21/02 4","C6aALZFt6Bx31oT9P5drHhhgYqC45C2pjHgBQmy2gwQh":"gorilla 21/02 3","HoGSP2KZBGCb8c8U5rRMHsJKtujwCxnzwHMWaxgENpiV":"gorilla 21/02 2","7Go1aik53DJzCSN3QnUqP4DHyhTPCcHG9Dxm7wqtEfmM":"gorilla 21/02 2","E7SEkq8f3Emq5xjdW5EQFhvrrnRPeoxre8NMQPUzNdup":"gorilla 30/12/25 ded","CFVVFXTQWc3WTjeUSPKWWXxqdSgkFuDZZ9oe1ERvVn2B":"gorilla 02/01 ded","332Jsfcacu7LXWuftR9kEBvGUWz219934ZNTgcxkqUeN":"gorilla 21/02","AZR5QHF92wHrfm3utwR7xXiJyZfxh3H7mt85ZBtUhAag":"gorilla hyperunit 20/12/25","9D9hChKatHBV3YVHPmAFn5uJyu9CPWYZ9bkdKkcQjd2j":"gorilla 13/02 2","7Zv6w23s3gYoZ2NWPUSFue7YayDUsStdyx8rtHrfTLaq":"gorilla 22/02 2","4Lzih31wEqanzykwqGqgzMRGbMeHgvbLZWGvriWZYs9h":"fomo gorilla 04/02/26","H4s69MLTU7yddjiNpVro8zY7Qr9j8WpkwGPvQfuSiH7C":"gorilla 21/12/25","9HRoyBdCL2QKwprkNtYhfH1eoWbrfvBbjkmHLG25QuUq":"debridge to arb depo gorilla","BWDabibKsomopJYXmYZ1nMUvcCU3ogAjug2cuX6ofnPN":"gorilla 22/02","74WArBKcT1w8U4wh23XzqYa49fa1Xn7mufaZSe6KpBET":"gorilla 23/01","Hi1PpARVHdmpVdH8mQ4LDiKjoTLXaK5Da2G8nn9KGFaj":"gorilla 16/01","HoqsYXMRTidjqgrbJ2h67WvHcNjGrRdrbWaNqkMZJfgC":"gorilla 10/02","2SMGKHQTvj1qXqiqsxahoE9qiM6FmpWivrMThQYpSutj":"gorilla 24/01 3","3utssfgjskkkZ7EZT4CjF17uhM7DYNVrDBHG1XfG9Jbk":"gorilla 13/02/26 2","BnmzHvh7zz9hTKb5Lur481sDxHJUMbczuLgr2Kd29tKX":"gorilla 24/01/26 2","Bh9jNiYVn5odWSyWEVvnq62zafzrxSEwCZg2NKBftSBr":"gorilla 13/02/26","7xwQVCUVWKEgqL4xios1dZVw7LqKFioGsSkN3LwdrgXX":"gorilla fomo aka dreamer","AgmLJBMDCqWynYnQiPCuj9ewsNNsBJXyzoUhD9LJzN51":"Fomo handler relay","FbmmdcCYHL7WETG89xtWmNFMzQAaQ8Zs9NXVbimibonk":"gorilla (dont)","E2HNWS5L6gwmtC9SZPpRq6Yp3V5gzotFrL3dAEP2pump":"gorilla (buckaru)","HYhnRdn7nridbDUUcRsd3JtmvMCyKrVDew52CWGtpump":"gorilla (crabs)","4q4Ta79pwyPqmSA3HDzrHN2wpwP8ManBREAbGskaqYcS":"gorilla 24/01/26","5M8AFcpRK2XF6a1kjZJVHTR7qRZ6kKcQwpvhMWGihWFh":"gorilla 13/08/25 2","HStKtZyR8Y1GHLGKHniZz5dHPPmonEagggwXuZerQcT7":"gorilla 31/07/25","8GTt87Yhc7Pt8RYWvv6paKoYkqav2yChsPby58kGQNro":"gorilla 13/08/25","ChSdhWe8Wd3jkT3Q3XzEMA3tiiCTqiek1pNdBXN5vGzo":"keep an eye gorilla","Ct8EUM6MvYjnM7ZTaBFR48riUBbnNquwNTSw16yMaEcQ":"gorilla 24/02/25","8PrA5iu9myM9azMSRpX1sDdoxCDNAVB47WS7GGoASxt1":"zu gorilla pub","C6uHvG7cE7FrfKXpYzR5zT1Cn8YXm6bwnFfZwaPnhhM7":"gorilla 07/07/24","5AfQobXKSFpktGCjU8PqdL3PpnYJRMB2GmSBR1sMKX94":"yolo capital","CMzohyRihiiuHMv6jGqkKn4BCpTqF7C2BFYk4BixfpUz":"gorilla 22/09/24","4vSDsWfStFupLapLeq9uyJ3CJeRjUgBmp8Zt67uLkhpP":"gorilla 20/09/24","DpNVrtA3ERfKzX4F8Pi2CVykdJJjoNxyY5QgoytAwD26":"gorilla pub","GzZkaM6SVQ7ZMvRsmjaHpinJKhQcpaFVp1Psi5n9MTya":"alon side 2","8QVfDrEPy3NqgecFea7N9nhiv1ZtYur8TSx53TzNvNpb":"zyaf 19/10/24","EUS2X7qYVUsjyePPoBj4tdkUytQp9sGtaC5gjZrB7Myn":"zyaf 23/04/25","GynZmiYUUNcogSpj11MLQBtHHqZDKCwArNEKwRQE6aY":"zyaf 02/12/24 e","ED5octcPzcb3rKQGmHth2PM6V5Frg3F7BVpeKkRjVuwh":"zyaf 13/08/25 e","Dgfo959yb3v6J9fv77aXypwf6QW7wMKQLCWztNWAqfeq":"zyaf 24/08/25 e","CiriWoZMwi3czto4EN4ZzVDGuohnJSquPPEwdTBRExEQ":"zyaf 30/01/26","EE9QiDFeoAc1mJY7QbPQXWH2CuE2iKmpNPr63TMfmnKf":"zyaf 31/01/26","7tNviT7hyPL8ZBxd68rMZ12TMDyUXmeSpHQruzLepump":"zyaf (britain)","UczQhjAv5JxMJewHQe4LRa3vA8aoZu56NeXXjRLaRzi":"zyaf 14/02/26","BX2HodhC5Ws6mxbLxtiurAUR8bnA3cdeEg3YF5fnpump":"zyaf (wuffy)","Em1LYWgfMMQLnGkpBjKTBtmif7DUnN6WLoHWDEdPzE8q":"push (zyaf)","6d7KJ5ihRqvS4H8qzcU5Gc84PMc5GgQSomKFg5sSpump":"zyaf (penguin)","HwtjjwinCEj5yaa6e5r17QVY3AzaJcRFArZyfoD8MCBG":"zyaf 21/01/26 1","J44TpMj45DDwkFWWCGby99bQp94AeNW2HuD9N7EhyDX6":"zyaf 21/01/26 11","2Q8UFrHN4rpTB64yxktUr5YQdF3hrvDHS7bgx22RhU8F":"zyaf 04/08/25","EEENP4BoQiRHg8u4WWXHeYjwJ4JCRh7XPkdwimr6pmLa":"zyaf 21/01/26 10","5ZEAy6iCgFmpr3Y1eWdQw4mQnxYijsPwVrQaLWeKh2Dx":"zyaf 21/01/26 9","DLCExpnRksZFgjuptrtA1pqL5CX4XBMh6bGxUFxkv9b3":"zyaf 21/01/26 8","8iCBk691DBtrn8Kbc8cdmWM2CvHrYtbeR5sUvRtEcHRm":"zyaf 21/01/26 7","E3JHCh2YfyxdZKtNBkNX5FkxQsy6mCYXWrarF7Shw968":"zyaf 21/01/26 6","9PcEyX5D7QDYGLUhdVNaaTMZyatZthbjuAhArg3mw726":"zyaf 21/01/26 5","4snNB7ExK6TonCbR31tdYTJo5nrxMDQEeaUe68kkca6h":"zyaf 21/01/26 4","6xWebSD4MdTBqBapeNconPrp4gm6okyQfghmpejEtRui":"zyaf 21/01/26 3","GrwtxBPfnVKoyx3bemyD2xHh3cMddGxXZyp1zHDU7vnt":"zyaf 21/01/26 2","2HtsVwJ4fWAjUuCaKrZcEJH5Up4AwdtDNn9TKz4k49jE":"zyaf 21/01/26 funder","F5TjPySiUJMdvqMZHnPP85Rc1vErDGV5FR5P2vdVm429":"zyaf pub","5zsms2suuYpGHWxSxwhjcjjbfmdg5kDcF8P6Sm6mX8EA":"zyaf 21/11/24","CMHDSs7fVPtbG3d8oqByURJsLXQQ1Mnig5yseihBgA8h":"zyaf stake","AEeJUPCiGR3yCoukTh1G58o4LYsUEyzrXtfmfMc2kJMX":"prosa pub","6rMJwMLi53FMdfeBLoarGaiDhUNJvcCLnVsZNUC3p6Fx":"joji 17/02 10","8M2Kgs8qB8eueZznPmje5Nr5p2JPixsRtk6XqqQ1bW7Q":"joji 17/02 9","Et5wDSMqSkThbUC5YeAEWVXe6F89vDUsj1XGdkSFUuHA":"joji 17/02 8","4yDsu6hWM17Zjw4Hw3bWr6vJgzm6qWPzRRVfdcj2Y1hf":"joji 17/02 7","2seKCYdewJnW2LHw4Du5ny2WwnSJmNbEJNDtGVk4YUcp":"joji 17/02 6","99EavkvU2GJSkeLiPvj8bZrjDxRVZZ7sLQPq6jUZwQ3H":"joji 17/02 5","4b7BDtuGmJeTrhAQKnH9duAriXY4GZzQhx2EoZoooJRD":"joji 17/02 4","HAHsreSidPrk8K2p8gcgPQHm7Ro4U54PBDjWoCgCa36m":"joji 17/02 3","iLziLkKoQLnhdcitJ4LGjfBXDnqKdVdpViJQMgt7ZiD":"joji 17/02 2","78VNQaanEqDb6k2yfxqjys72yJqJMn7y2kXdYisMETuP":"joji 17/02","Dew96gG2FPjKTmbG2KfKi18QYAFzn2QYfoBPdk6LhbJA":"jeets 05/02/26","5yNvHQ84Keh2vwamF7KN4TGtN29uW7TzrZSWvJyppump":"jeets (67kitten)","4zL98Nncs8mHn3Aaw8naCdusLbRStKoxcfHqA4Wwpump":"jeets (granny)","DEffWzJyaFRNyA4ogUox631hfHuv3KLeCcpBh2ipBAGS":"jeets (x1xhlol)","F2ML2wkxsxSANLQ6bcqqL31mtD6pki8zxYjCvPAapump":"jeets (liberal)","jk1T35eWK41MBMM8AWoYVaNbjHEEQzMDetTsfnqpump":"jeets (sol)","DNnzSTbL8z4x28ji2dDmZKnYAbLf8zcmqiG9UjArpump":"jeets (profit)","9CaWKwDJPFTrkJuk5dj1Vyc2TBse9CjQFmomVGkrpump":"jeet (cry)","7wTLX7t2aeiXnn2D1QHdo1nk4CLYvAfYHV8eFScSpump":"jeets (epsteinify)","H1Ki3Tzj1xdTBHRkTuBGBxyGVUnkjTundBWXosAgaTVW":"beaver 11/04/24","3mqpeju61XkyxyV4YMJUKknvQCdBupC4PuHVah85tXij":"beaver 02/01/26","49r9nvpjBDG2jiLbNFstymeJpTxRGTJ9HJSUEkQrUQJy":"numero 20/04/25","A6pRbxYPThf94QA9YTV2r3YoVScRygX4kBMtmf6BUffD":"numero 08/12/25","GaFaZmqreUsj5LtZzAEFdooPDRQ5FJ3Fx7jm4D5Nh9qw":"numero 23/12/25","4jNSkRdgvUPWqy6aqMdZhq2nkgeiqZRtJm2SjwcihQf4":"numero fireblock depo","56LApavmurT9KYzGdjP3yVTPQLUE6FhV4wN2ae1SSK6C":"numero 27/11/25","EaTxzqwCUUvFt4C6DJqbEnNUKa59vudPQHHd53xs4Uhc":"numero 12/07/25","FHJi5fKepQPHDvx3mY2Y79bYkkv4t7PvVJbuG43gSi43":"fireblock 2","A3W8psibkTUvjxs4LRscbnjux6TFDXdvD4m4GsGpQ2KJ":"numero pub","DjLmg7pD3Mqa7PccpaueQbn2skD8dPoe9vkeMnRrKj2i":"drnell 23/11/25","3jzHjoPKaceZjA6AqAWka7Ghw9F3w9k9cvjGTmybdioT":"drnell pub","6m5sW6EAPAHncxnzapi1ZVJNRb9RZHQ3Bj7FD84X9rAF":"js pub","4W1yv45AjfxunuNyy7NSxiNMssmUnatp35hwtcNAsUWS":"cooker 30/03/24","FFM6Eaf7Y43ganwnTYzWdsN1La3J1uZRMbqqZgh3ruFJ":"cooker 26/01/24","HKBjx9fkQFm9RuiMBz9Tjm57sv7Aos9wnP9VR13bTa6r":"cooker 23/04/25 3","66rx8C9SmxWqAhsnC4nSJUnD48uBWbDtXdmQviAyfakm":"cooker 10/04/25 3","4AH7L6VYGrxZxw7FXFUwwsW1oaMhqicjcBd3rsfG2E95":"cooker 10/04/25 2","5vgZSBRJ7nEbgQS5zLrx6H1TrvAS1EU5BjUUHkXDyfXx":"cooker 14/04/25","H812jAz5Z5t8cvfXoxbE27Q2F89eovpib5kpXawLAFdS":"cooker 23/04/25 2","J1LuQipHu4XvsjdkvCs5DvzjziVdBQ3JRZHcTPPoeNPn":"cooker 23/04/25","CRumpjJLuC1rbACdgAjekMAWtivpcdPaJHXa3r8o2sko":"cooker 10/04/25","5rFwZ6uKBziJWYjkPrWWLfjGPtoAdzFj1QLvm5cpFsuN":"cooker 23/04/25","cookerLHBByvhtrsM3LR9sip2eNYLexbQbBX2WjQj4C":"cooker 18/03/24","DRj22bvKEMi2muGYGLMcbfaTBiNEQUdiN8xkSbeMjTuu":"cooker 21/03/24","8deJ9xeUvXSJwicYptA9mHsU2rN2pDx37KWzkDkEXhU6":"cooker pub","ENPJzR1TXAgPXCMvxv8owma5b7HNRRb1ym11a9yDowRv":"ily 07/12/25","XXXXXahGswEH6i3Czn19XbGxQrobJoY1TYJegPxp3ex":"ily 03/06/25","B39wwJMYwNxPUHxihEeh5o6gDbVgAMsZCssSDeVBTp8b":"ily 03/06/25","9EfTigVxHuNjqzxiv3BQ7wD2v7uFvdRQbrrnDEPr8pTk":"see pub","9o6NaDxWW4ZXL5TnBPJ7HiGXVr31ckKBwukFSEwTtXHw":"leens 08/04/25","Cwr5HPhvRzq8xUcjLT6Th2dYW4MYVwtrNy54bKxma6m7":"leens 22/09/25","3KNKpoWp36AJWTG3fz5rd6DXkvb9ocgBr4ZeBfNh3ECU":"leens 18/06/25","EEdevLwpsoy6HqhumAtb7F9AXq5jhNkX24cYGjyfC1Cu":"leens vault","6fWucGoQiYTpYBHfA3Z5g1s4w75o1wdT39e54bw8DaDP":"leens 13/01/26","uFYygPd9z8yP2kjPA37NgzRj5TtHgPKp8SwDMkLA9Am":"leens 26/11/25","BDgTxheDvhD1nvdV5HWgoX1LpbV4BQCccGVD7Lopf8Gw":"leen 19/12/25","LeenseyyUU3ccdBPCFCrrZ8oKU2B3T2uToGGZ7eVABY":"leens public","9Qh5HKHDJj7cjLF9vG16iuPxtXs6QY6dD5tSwgRheJ9m":"durden vault/ledger","BYnJkqF9YfzkDHcSpRgKD8WGyLhp32Yrk4CkGAHLZTFc":"duve 14/06/25 2","6Eegkyd2qNzxSzZz3PH3jiDyqL5HFcHdcsb9zfMzWHKB":"duve 17/05/25","D7xK1ZLz8KQNWN8aU1jbzNAuT5xwqgFrCUUYodVU4G42":"duve 24/05/25 2","7uyGRgoCRKfynPbB35kWQwEGz9pmRvUyNFunV939mXpN":"duve 24/05/25","8PXKkrJriorsPJvrBcehPxYfFsXqEUTc5cNSPf4WFAvj":"duve 14/06/25","9bRSMdwQ6ZZJs1WySnHhSt1SYdLghZtQBiUCqnjNaun4":"duve 14/06/25","BAr5csYtpWoNpwhUjixX7ZPHXkUciFZzjBp9uNxZXJPh":"Duve public","Fb74egXvPwYn7gQEQMnYgFr4pK1CxVUfafsU53PmX8UB":"kilo 20/01/26","6U6KDci3UcWHQQzaVCPC1k72vRxTtrehQF2vjK4U1cLV":"kilo 10/01/26","9AFJRjtDeX3dbU93Bc52wENpGeYWNYcjvyrirnZGmXWR":"kilo 12/01/26","GsUjBD4yeJjpGsoH27yHpGF7b1TXdvNYZ3HKcujYSRm1":"jeets 16/04/25","A4eKqW6Ep7a8xDxPitDcDMWLo6Zh73nGzh64rR79auve":"alon sidewallet","2f9uy52Vrh1Jjv82RJqzZHPrHEpa827kea3EJX4sLi2V":"jeets 19/03/25 2","3eKcfi2sVxs8THLhUhokyhjMMiD8m5hR8w6ryunbKENZ":"jeets 19/03/25","7HDFJKX9wwcdok8ndrkDn8e6HuTvVS8pMEJXYdAa5sbb":"Jeets 03/01/25","28GtM11GagMc6YNK5kHQTY5RKAig7nXjrYfg1kYkMXPM":"jeets 19/03/25","CvLHr9x7owfXphpPHD5bEtAcN8XSnH2p8txmA7KkTFtB":"jeets 10/02/25","8WWugerHLKM186wVycJxTMnCPazpxbmYJwfj4kEFJGjo":"jeets 27/11/24","26Ly5ZhutPh9YiYh4KikeXLC7qcGnFQNP7yJhHieKfBo":"jeets 01/08/25","5i6jhx8vqBpvT9Ejej6u1R8iFmtHzgbmYd77Unfnm8YL":"jeets 16/04/24","BajX9pPHRuENwGDHHK2PWiVp7qnJKMtWXzX16NZqtKim":"jeets 01/08/25","4hkehi2VyrcN3Kz3j7Ab7EZNmCM4Qyu8ymdbwx5S6vHb":"x.com/Di_meji_","9iaawVBEsFG35PSwd4PahwT8fYNQe9XYuRdWm872dUqY":"meechie public","FU3dKmKF1X5xMDqW47avy8kA83FMojxGkM1WJsimREZN":"ace 16/01/25","4eG2Wtpnq5Ye2R9VaK2bwdC44FAwoMEcw1AQKURpKZ2V":"ace main","A5m4fK8hbHBFBgbLuQ9iixBQDCS3tWibh3WCrHWMJJkp":"ily 01/12/25","23ci89gE4DiFMiW7NduxqrgEkGvY8g4VkQ1RQQ9UEctf":"empty ily 2","24kucYx9hPYAUUzoS7bw1iTWnUj7t6xtKFRhZDNQ8a1i":"empty ily","8zdWnVBJ1BdGNgRuwtS2PFvjcphXoUsrgs5nuuHqzB55":"ily 20/07/24","9ZXQuDxSNQKTE5tc6dgxVu4Mi2fYVQRzMYVCT7eufsXh":"ily 25/06/24","F8Wf7BWppzk8naGB4VDQE1R7TV3JvHSRwRT1vy6YWuBP":"ily 29/11/25","FDG5mBzicyoUjMzFke4A9ZEChuTrRfGiFVivyfx1nnnf":"ily 28/11/25","AcoNeFQsTPYs7ZrH8RMWaxxGJTTQJJ4H5aTXmptaz5UK":"ily 21/10/25","5XVKfruE4Zzeoz3aqBQfFMb5aSscY5nSyc6VwtQwNiid":"ily public","kiLogfWUXp7nby7Xi6R9t7u8ERQyRdAzg6wBjvuE49u":"kilo challenge wallet","4ASkzDGfVoQt43m3uzWnExgJFxC478ZLjBARAkrLSS7M":"jeets 02/06/25","5qoC7f1Hmqf1jXmJuBraXU9KecoS5Xw2hLg5wVhRtWTs":"dln 03/06/24 2","HrTVfraVPthAvPsBLEaB7wTkZ6BgS9MsoguaUREsUYFc":"03/06/24 dln","DU96wTmYs1w2Q3pZCvuDAAbXTJh69tH55H1Uue5wTAzB":"dln 14/10/21","4Hecrec4JCjiNgNhoVWneB1EcbfjiHmZZ542CGuUvsk7":"dln 06/05/24","4hwPamSooBr5JhxHdcEC21HoxN5HUwYR2hGucLPyZAi8":"AdamJae 2","8Dg8J8xSeKqtBvL1nBe9waX348w5FSFjVnQaRLMpf7eV":"AdamJae","56DXiyd4T12ZKn433USQVix7cPYjbuhisPrN6cL3pump":"dln (fake 2016)","EwEJ5R1im54MowvsGwYUkyfWRMV1qcRL21PumVd4pump":"dln (2016)","FGsy9L6WKnkLraUoW8aBv6wFbm29HzuJD1GJJwgdBH3E":"dln 16/01/26","BequYtmFhQqzkNdvPfAuMeQySkq2EbCLtt3piUdqU3zR":"dln 03/06/24 2","43MUX5WAKogwNmCEo2xJ3ya8ucdbfkFE7W4NQdikNrd5":"dln 03/06/24","CfTeF7K5rxUt45vioJ2rSq774rBBZ4apMww8D7EzGJsm":"dln 03/06/24","HkiCryXaSgvYPHenUv2YYfcoYd8HcNgUUDKZdScpyP6Z":"dln 21/06/24","4vMAMJ19F9Qn4ApboBeCjnpowtZVgn7fS2UdKsKZkgiQ":"jeets 11/01","4VizQmw5gt688wMouEzvitRP723SF4UTHbDWALvEZJFt":"jeets 06/11 2","6CpQyLuVsM6XkTo7t5ie5jFRfRNSjBVzbL97t1syf1ST":"jts 06/11","FgQaR3GSiy123xCfiP8LmT6Grsz5UvXTbQetU9uGYGnC":"2 Jts 11/01","F5CbRKW1AzRXZayzh7czPVPf1ytqDrwy5giQuzoZGFUZ":"jeets 06/11 3","9JwDv7f5DvytSKr4p1btrXt8BhGHTPz37mYzRy1V9mTE":"dln 14/10/21","6ce2TqJYWthujt2qmX83m3i3SDa81SGfSyfz7wz8sE4E":"dln 07/04/25","Fo2XGAesgep3Y3astNhxnXhX5YNV9GZQbgnjkX3UdAzT":"dln 04/10/21","HG69UWr6m3RnY3tayNN3qXA2r2BwiGwQL78QS6z54wdd":"dln 01/09/21","cSySQQEQpzc7MmWkTGDWNtnBiNC3jt9c9iygLUqkoth":"dln (koth)","DPgDAtQoyFZprtxnn3wvE4vgbTqFaQKy8xMX3jo7moyo":"dln monad transfer lookinto","5QCN4KGpt78HRfmhqDv8PfGxuQ4s74FgXeNJMfAZpwsC":"dln 07/12","JAXunqm72N4i3UEmMRS3BrDc92Aue3eHbq5EHatceP2D":"dln troll hold","EWJuYRkYc5rPRFoRkuuevVRwrkXBQgEQttwFXqDzG3Hs":"dln main","4Fg9ZJTxDiXqHfQVWRp2GmX3Pnhu39N7645npc2Lmvi8":"michibets 2","BBy28ipppJZqh76Ea7BpRZA9A8bbYhUT4EMz3SF1HFt9":"michibets 1","2kEdCTezdqek6T3XKGhR2JjJNA96qkTVhNLe9nCZECdc":"padre","2dRXemtND4YgQhf6UQwaSe2qNDRQ4HBSTuRi2it9No3N":"monad transfer jeets","CmgJ1PobhUqB7MEa8qDkiG2TUpMTskWj8d9JeZWSpump":"jeets/marcel (rainbowfish)","8cuPhLexSdj8UWJ2RXy3XKQuX1F2kriWWcfpuBC6CbXL":"Jeets 14/08/25","FUTrtAEMfVCnRDQTtmX4urktLarNzxcwPesdikpa1gJA":"Jeets 01/01","B2oW2hMKZKpRV1VP8toiFbvcM1ZMoGNhJJxjEf1nvT4A":"ieatjeets (fuckyou)","D1H83ueSw5Nxy5okxH7VBfV4jRnqAK5Mm1tm3JAj3m5t":"IEatJeets Public","9Xe8eLBD4N3JiF5KbRLDgmYc5BH5Z4ro3ggec8ZPVaS4":"dream no4 2","FQdhAn3XDz4RmKHen99PgZmRzXuNbsztc4T797UQqkGd":"dream no4 1","3jGpGxKMwBsv2vZWsRajueBCKmmDLEjkvZrRintnFZ5B":"dream no13","CoAo4EAB6iNpULpvTgdgzJjJ8C494edvuvuTLtnWDT3S":"dream no7","Eqdj4pSmEoG1vzzZFMrS5DabXRvt7GyHM1fEssRgpDd2":"Dream no4","5TW8LCGK3WknGWjmfpG3H2qC5Hh7825ZGjQRjuUwwhmo":"pj 13/12","EdhUNnenSbFs2o2BLTQMRwAKq2m5DcFR9MVAS4P1KV5i":"pj 08/12","BqkwQDRe27MpkT7ntLyCKrw6gNHvEX4xJytKZ7KH7jig":"drdn 2","GM7Hrz2bDq33ezMtL6KGidSWZXMWgZ6qBuugkb5H8NvN":"beaver public","7jXmaKA2amexHBrjDXeSXgGBwoWDaXkU6XgiPpnh595y":"bullishdegen dev","GPs2LVif4KuHLPp2DwNYFPsbbWEjGdwmMY2UEArtpebE":"lexapro 21/11 maybe","Hg4FDf67tLcfWR9viFKTpFasZge7pZWwm24UZajCcWsZ":"lexapro 21/11 trans","8yJFWmVTQq69p6VJxGwpzW7ii7c5J9GRAtHCNMMQPydj":"Lexapro public 21.11","7sLZtYseCR9HpvuryQRdbftbw4jYSoH2FBSyihdWhT41":"drdn 19/11","F99SztC8CiNvPmgGwLeNnvAfpYi5JhGPAzdoRV7MDAUv":"byinx 05/09","Gk4s5DJRV1H1ACnMjSS7etS81LjjsreVFk6X3MSWVsEk":"helmet"
};

const BLACKLIST = new Set(["JUP4Fb2cqiRUcaTHdrPC8h2gNsA2ETXiPDD33WcGuJB","JUP6LkbZbjS1jKKwapdHNy74zcZ3tLUZoi5QNyVTaV4","jupoNjAxXgZ4rjzxzPMP4QqTBHEUCgx6KQNC7WxVBB","675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8","5quBtoiQqxF9Jv6KYKctB59NT3gtFD2XqWQFkZB1GADY","RVKd61ztZW9GUwhRbbLoYVRE5Xf1B2tVscKqwZqXgEr","CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK","9W959DqEETiGZocYWCQPaJ6sBmUzgfxXfqGeTEdp3aQP","whirLbMiicVdio4qvUfM5KAg6Ct8VwpYzGff3uctyCc","6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P","TSLvdd1pWpHVjahSpsvCXUbgwsL3JAcvokwaKt1eokM","srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX","9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin","TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA","ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJe1bT","11111111111111111111111111111111","So11111111111111111111111111111111111111112","BQ72nSv9f3PRyRKCBnHLVrerrv37CYTHm5h3s9VSGQDV","2MFoS3MPtvyQ4Wh4M9pdfPjz6UhVoNbFbGJAskCPCj3h","HU23r7UoZbqTUuh3vA7emAGztFtqwTeVips789vqxxBw","3CgvbiM3op4vjrrjH2zcrQUwsqh5veNVRjFCB9N6sRoD","CapuXNQoDviLvU1PxFiizLgPNQCxrsag1uMeyk6zLVps","GGztQqQ6pCPaJQnNpXBgELr5cs3WwDakRbh1iEMzjgSJ","9nnLbotNTcUhvbrsA6Mdkx45Sm82G35zo28AqUvjExn8","6LXutJvKUw8Q5ue2gCgKHQdAN4suWW8awzFVC6XCguFx","3LoAYHuSd7Gh8d7RTFnhvYtiTiefdZ5ByamU42vkzd76","DSN3j1ykL3obAVNv7ZX49VsFCPe4LqzxHnmtLiPwY6xg","69yhtoJR4JYPPABZcSNkzuqbaFbwHsCkja1sP1Q2aVT5","6U91aKa8pmMxkJwBCfPTmUEfZi6dHe7DcFq2ALvB2tbB","7iWnBRRhBCiNXXPhqiGzvvBkKrvFSWqqmxRyu9VyYBxE","4xDsmeTWPNjgSVSS1VTfzFq3iHZhp77ffPkAmkZkdu71","GP8StUXNYSZjPikyRsvkTbvRV1GBxMErb59cpeCJnDf1","HFqp6ErWHY6Uzhj8rFyjYuDya2mXUpYEk8VW75K9PSiY"]);

// Ed25519 on-curve check
function isOnCurve(address) {
  try {
    const ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
    let n = 0n;
    for (const c of address) {
      const i = ALPHABET.indexOf(c);
      if (i < 0) return false;
      n = n * 58n + BigInt(i);
    }
    const bytes = new Uint8Array(32);
    for (let i = 31; i >= 0; i--) { bytes[i] = Number(n & 0xffn); n >>= 8n; }
    const p = (1n << 255n) - 19n;
    const d = 37095705934669439343138083508754565189542113879843219016388785533085940283555n;
    let y = 0n;
    for (let i = 31; i >= 0; i--) y = (y << 8n) | BigInt(bytes[i]);
    const sign = y >> 255n;
    y &= (1n << 255n) - 1n;
    const y2 = y * y % p;
    const u = (y2 - 1n + p) % p;
    const v = (d * y2 + 1n) % p;
    const modpow = (b, e, m) => { let r = 1n; b %= m; while (e > 0n) { if (e & 1n) r = r * b % m; e >>= 1n; b = b * b % m; } return r; };
    const x2 = u * modpow(v, p - 2n, p) % p;
    if (x2 === 0n) return sign === 0n;
    let x = modpow(x2, (p + 3n) / 8n, p);
    if (x * x % p !== x2) x = x * modpow(2n, (p - 1n) / 4n, p) % p;
    if (x * x % p !== x2) return false;
    return true;
  } catch { return false; }
}

// State
let coinCount = 0;
let lastResults = [];
let lastLabels = [];

function addCoin(label = '', mint = '') {
  coinCount++;
  const list = document.getElementById('coinsList');
  const row = document.createElement('div');
  row.className = 'coin-row';
  row.id = `coin-${coinCount}`;
  row.innerHTML = `
    <input class="label-input" placeholder="Label (e.g. PEPE)" value="${label}" style="font-size:12px;">
    <input placeholder="Mint address (CA)" value="${mint}" style="font-size:11px;">
    <button class="remove-btn" onclick="removeCoin(${coinCount})" title="Remove">×</button>
  `;
  list.appendChild(row);
}

function removeCoin(id) {
  const el = document.getElementById(`coin-${id}`);
  if (el && document.querySelectorAll('.coin-row').length > 2) el.remove();
}

function setStatus(msg) {
  const el = document.getElementById('status');
  el.innerHTML = `<span class="spinner"></span>${msg}`;
  el.classList.add('visible');
}

function clearStatus() {
  document.getElementById('status').classList.remove('visible');
}

function showError(msg) {
  const el = document.getElementById('errorMsg');
  el.textContent = msg;
  el.classList.add('visible');
}

function clearError() {
  document.getElementById('errorMsg').classList.remove('visible');
}

async function fetchHolders(mint, label) {
  const holders = {};
  let cursor = null;
  let page = 1;
  let filtered = 0;

  while (true) {
    const params = { mint, limit: 1000, displayOptions: { showZeroBalance: false } };
    if (cursor) params.cursor = cursor;

    const resp = await fetch(HELIUS_RPC, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ jsonrpc: '2.0', id: 'scan', method: 'getTokenAccounts', params })
    });

    const data = await resp.json();
    if (data.error) throw new Error(`API error for ${label}: ${data.error.message}`);

    const accounts = data?.result?.token_accounts || [];
    if (!accounts.length) break;

    for (const acc of accounts) {
      const wallet = acc.owner;
      const amount = parseFloat(acc.amount || 0);
      if (!wallet || amount <= 0) continue;
      if (BLACKLIST.has(wallet)) { filtered++; continue; }
      if (!isOnCurve(wallet)) { filtered++; continue; }
      holders[wallet] = amount;
    }

    setStatus(`Fetching ${label} — page ${page} (${Object.keys(holders).length} holders, ${filtered} filtered)`);
    cursor = data?.result?.cursor;
    if (!cursor || accounts.length < 1000) break;
    page++;
    await new Promise(r => setTimeout(r, 150));
  }

  return holders;
}

async function runScan() {
  clearError();
  const rows = document.querySelectorAll('.coin-row');
  const coins = [];
  for (const row of rows) {
    const inputs = row.querySelectorAll('input');
    const label = inputs[0].value.trim();
    const mint  = inputs[1].value.trim();
    if (label && mint) coins.push({ label, mint });
  }

  if (coins.length < 2) return showError('Please enter at least 2 coins.');

  const minPct    = parseFloat(document.getElementById('minPct').value) || 0;
  const maxResults = parseInt(document.getElementById('maxResults').value) || 100;

  document.getElementById('scanBtn').disabled = true;
  document.getElementById('results').classList.remove('visible');
  setStatus('Starting scan...');

  try {
    const allHolders = [];
    for (const { label, mint } of coins) {
      setStatus(`Fetching holders for ${label}...`);
      const h = await fetchHolders(mint, label);
      allHolders.push(h);
    }

    setStatus('Finding overlap...');

    // Intersection
    let common = new Set(Object.keys(allHolders[0]));
    for (let i = 1; i < allHolders.length; i++) {
      common = new Set([...common].filter(w => allHolders[i][w]));
    }

    // Compute totals for %
    const totals = allHolders.map(h => Object.values(h).reduce((a, b) => a + b, 0));

    // Build results
    let results = [];
    for (const wallet of common) {
      const pcts = allHolders.map((h, i) => totals[i] > 0 ? (h[wallet] / totals[i]) * 100 : 0);
      if (minPct > 0 && pcts.some(p => p < minPct)) continue;
      results.push({ wallet, label: globalWallets[wallet] || '', amounts: allHolders.map(h => h[wallet]), pcts });
    }

    results.sort((a, b) => b.pcts[0] - a.pcts[0]);
    lastResults = results;
    lastLabels  = coins.map(c => c.label);
    lastIsHistorical = false;

    clearStatus();
    renderResults(results.slice(0, maxResults), lastLabels, results.length, false);

  } catch (e) {
    clearStatus();
    showError(e.message || 'Scan failed. Check mint addresses and try again.');
  }

  document.getElementById('scanBtn').disabled = false;
}

function renderResults(results, labels, total, historical = false) {
  const known = results.filter(r => r.label).length;
  const modeTag = historical ? ' &nbsp;<span style="color:var(--accent2);font-size:9px;letter-spacing:1px;">HISTORICAL</span>' : '';
  document.getElementById('resultsStats').innerHTML =
    `<span>${total}</span> wallets match &nbsp;·&nbsp; <span>${known}</span> known${modeTag}`;

  // Build table header
  let headHTML = '<tr><th>Wallet</th><th>Known As</th>';
  if (historical) {
    for (const l of labels) headHTML += `<th>${l.toUpperCase()} STATUS</th>`;
  } else {
    for (const l of labels) headHTML += `<th>${l.toUpperCase()} %</th><th>${l.toUpperCase()} BAL</th>`;
  }
  headHTML += '</tr>';
  document.getElementById('tableHead').innerHTML = headHTML;

  // Add historical note
  const noteEl = document.getElementById('histNote');
  if (historical) {
    if (!noteEl) {
      const note = document.createElement('div');
      note.id = 'histNote';
      note.className = 'hist-note';
      note.innerHTML = '⚡ Historical mode — showing every wallet that ever interacted with these coins';
      document.getElementById('results').insertBefore(note, document.querySelector('.table-wrap'));
    }
  } else {
    if (noteEl) noteEl.remove();
  }

  // Build rows
  let bodyHTML = '';
  if (!results.length) {
    bodyHTML = `<tr><td colspan="${2 + labels.length * (historical ? 1 : 2)}" class="no-results">No matching wallets found.</td></tr>`;
  } else {
    for (const r of results) {
      const short = r.wallet.slice(0,6) + '...' + r.wallet.slice(-4);
      const solscanUrl = `https://solscan.io/account/${r.wallet}`;
      let row = `<tr>
        <td><div class="wallet-cell">
          <a class="wallet-addr" href="${solscanUrl}" target="_blank" title="${r.wallet}">${short}</a>
        </div></td>
        <td>${r.label ? `<span class="known-badge">${r.label}</span>` : ''}</td>`;
      if (historical) {
        for (let i = 0; i < labels.length; i++) {
          const holding = r.stillHolding[i];
          row += `<td>${holding
            ? '<span class="holding-badge">HOLDING</span>'
            : '<span class="exited-badge">EXITED</span>'}</td>`;
        }
      } else {
        for (let i = 0; i < labels.length; i++) {
          const pctClass = r.pcts[i] >= 0.1 ? 'pct-high' : 'pct-cell';
          row += `<td class="${pctClass}">${r.pcts[i].toFixed(4)}%</td>`;
          row += `<td class="bal-cell">${r.amounts[i].toLocaleString(undefined, {maximumFractionDigits: 0})}</td>`;
        }
      }
      row += '</tr>';
      bodyHTML += row;
    }
  }
  document.getElementById('tableBody').innerHTML = bodyHTML;
  document.getElementById('results').classList.add('visible');
}

function exportCSV() {
  if (!lastResults.length) return;
  const headers = ['Wallet', 'Known As', ...lastLabels.flatMap(l => [`${l} Balance`, `${l} % Supply`])];
  const rows = lastResults.map(r => [
    r.wallet, r.label,
    ...r.amounts.flatMap((a, i) => [a.toFixed(2), r.pcts[i].toFixed(4) + '%'])
  ]);
  const csv = [headers, ...rows].map(r => r.map(v => `"${v}"`).join(',')).join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
  a.download = `overlap_${lastLabels.join('_')}_${Date.now()}.csv`;
  a.click();
}


// ── Password Gate ────────────────────────────────────────────────────────────
const PWD_HASH   = 'f0c7a7dcf00c8422d3eb78b00831d27a183b555b2826fbea42354aa467d8b75c';
const COOKIE_KEY = 'overlap_auth';
const COOKIE_DAYS = 30;

function setCookie(name, value, days) {
  const expires = new Date(Date.now() + days * 864e5).toUTCString();
  document.cookie = name + '=' + value + '; expires=' + expires + '; path=/; SameSite=Strict';
}

function getCookie(name) {
  return document.cookie.split('; ').reduce((r, v) => {
    const [k, val] = v.split('=');
    return k === name ? val : r;
  }, null);
}

async function hashStr(str) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function checkPassword() {
  const val = document.getElementById('pwdInput').value;
  const hash = await hashStr(val);
  if (hash === PWD_HASH) {
    setCookie(COOKIE_KEY, hash, COOKIE_DAYS);
    unlockApp();
  } else {
    const input = document.getElementById('pwdInput');
    const err   = document.getElementById('pwdError');
    input.classList.add('error');
    err.textContent = 'Incorrect password';
    setTimeout(() => { input.classList.remove('error'); err.textContent = ''; }, 1500);
    input.value = '';
  }
}

function unlockApp() {
  document.getElementById('pwdOverlay').style.display = 'none';
}

function checkCookie() {
  if (getCookie(COOKIE_KEY) === PWD_HASH) unlockApp();
}

// Allow Enter key on password input
document.getElementById('pwdInput')?.addEventListener('keydown', e => {
  if (e.key === 'Enter') checkPassword();
});

checkCookie();
// ─────────────────────────────────────────────────────────────────────────────

// ── Firebase Setup ───────────────────────────────────────────────────────────
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDqONDYKXTJUMcEdQmAhTN00030LeSvtSo",
  authDomain: "overlap-2afee.firebaseapp.com",
  projectId: "overlap-2afee",
  storageBucket: "overlap-2afee.firebasestorage.app",
  messagingSenderId: "467661446034",
  appId: "1:467661446034:web:cbe7b70c64bdecc1ca3f4b"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const WALLETS_DOC = doc(db, "overlap", "wallets");

// ── Wallet Manager ───────────────────────────────────────────────────────────
let globalWallets = {};
let userWallets   = {};

function setSyncStatus(state) {
  const dot   = document.getElementById('syncDot');
  const label = document.getElementById('syncLabel');
  if (!dot) return;
  dot.className    = 'sync-dot ' + state;
  label.textContent = state === 'synced' ? 'synced' : state === 'syncing' ? 'saving...' : 'offline';
}

// Realtime listener — fires on every change from any user
function startRealtimeSync() {
  setSyncStatus('syncing');
  onSnapshot(WALLETS_DOC, (snap) => {
    userWallets   = snap.exists() ? (snap.data().wallets || {}) : {};
    globalWallets = { ...TRACKED_BASE, ...userWallets };
    setSyncStatus('synced');
    renderWalletList();
    updateWalletTabCount();
  }, () => setSyncStatus('offline'));
}

async function saveWallets() {
  setSyncStatus('syncing');
  try {
    await setDoc(WALLETS_DOC, { wallets: userWallets });
    setSyncStatus('synced');
  } catch (e) {
    console.error(e);
    setSyncStatus('offline');
  }
}

async function addTrackedWallet() {
  const addr  = document.getElementById('newWalletAddr').value.trim();
  const label = document.getElementById('newWalletLabel').value.trim();
  if (!addr || !label) return;
  if (addr.length < 32) { alert('Invalid address — must be a full Solana public key'); return; }

  const btn = document.getElementById('addWalletBtn');
  btn.disabled = true;
  btn.textContent = '...';

  userWallets[addr]   = label;
  globalWallets[addr] = label;
  await saveWallets();

  document.getElementById('newWalletAddr').value  = '';
  document.getElementById('newWalletLabel').value = '';
  btn.disabled    = false;
  btn.textContent = 'ADD';
}

async function removeWallet(addr) {
  if (!userWallets[addr]) {
    alert('Built-in wallets cannot be removed.');
    return;
  }
  if (!confirm(`Remove "${userWallets[addr]}"?`)) return;
  delete userWallets[addr];
  delete globalWallets[addr];
  await saveWallets();
}

function renderWalletList() {
  const el    = document.getElementById('walletListEl');
  const count = document.getElementById('walletCount');
  const entries = Object.entries(globalWallets);

  count.innerHTML = `<span>${entries.length}</span> wallets tracked &nbsp;·&nbsp; <span>${Object.keys(userWallets).length}</span> added by your group`;

  if (!entries.length) {
    el.innerHTML = '<div class="empty-wallets">No wallets yet. Add one above.</div>';
    return;
  }

  const userEntries = entries.filter(([a]) =>  userWallets[a]);
  const baseEntries = entries.filter(([a]) => !userWallets[a]);
  const sorted = [...userEntries, ...baseEntries];

  el.innerHTML = sorted.map(([addr, lbl]) => {
    const short  = addr.slice(0,6) + '...' + addr.slice(-4);
    const isUser = !!userWallets[addr];
    return `<div class="wallet-item">
      <div class="wallet-item-addr">
        <a href="https://solscan.io/account/${addr}" target="_blank" style="color:inherit;text-decoration:none;" title="${addr}">${short}</a>
        ${isUser ? '<span style="font-size:9px;color:var(--muted);margin-left:6px;">✦ group</span>' : ''}
      </div>
      <div class="wallet-item-label">${lbl}</div>
      <button class="remove-btn" onclick="removeWallet('${addr}')" title="${isUser ? 'Remove' : 'Built-in'}" style="${!isUser ? 'opacity:0.2;cursor:default;' : ''}">×</button>
    </div>`;
  }).join('');
}

function updateWalletTabCount() {
  const el = document.getElementById('walletTabCount');
  if (el) el.textContent = Object.keys(globalWallets).length;
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach((t, i) => {
    t.classList.toggle('active', ['scan','wallets','saved'][i] === tab);
  });
  ['scan','wallets','saved'].forEach(id => {
    document.getElementById(`tab-${id}`).classList.toggle('active', id === tab);
  });
  if (tab === 'saved') loadSavedScans();
}

document.addEventListener('DOMContentLoaded', () => {
  ['newWalletAddr','newWalletLabel'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('keydown', e => { if (e.key === 'Enter') addTrackedWallet(); });
  });
  startRealtimeSync();
  loadSavedScans();
});
// ─────────────────────────────────────────────────────────────────────────────

// ── Saved Scans ──────────────────────────────────────────────────────────────
const SCANS_COL = doc(db, "overlap", "scans");

async function saveScan() {
  if (!lastResults.length) return;
  const name = prompt('Name this scan (e.g. "GAS x BLOXX"):');
  if (!name || !name.trim()) return;

  // Grab mint addresses from current inputs
  const coinRows = document.querySelectorAll('.coin-row');
  const coinMints = [];
  coinRows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    coinMints.push(inputs[1].value.trim());
  });

  const scanData = {
    name:       name.trim(),
    coins:      lastLabels,
    mints:      coinMints,
    savedAt:    Date.now(),
    matchCount: lastResults.length,
  };

  try {
    const snap = await getDoc(SCANS_COL);
    const existing = snap.exists() ? (snap.data().scans || []) : [];
    existing.unshift(scanData);
    await setDoc(SCANS_COL, { scans: existing });
    renderSavedScans(existing);
    updateSavedTabCount(existing.length);
    // Flash the tab
    switchTab('saved');
    setTimeout(() => switchTab('scan'), 1500);
  } catch (e) {
    alert('Failed to save: ' + e.message);
  }
}

async function loadSavedScans() {
  try {
    const snap = await getDoc(SCANS_COL);
    const scans = snap.exists() ? (snap.data().scans || []) : [];
    renderSavedScans(scans);
    updateSavedTabCount(scans.length);
  } catch { renderSavedScans([]); }
}

function renderSavedScans(scans) {
  const el = document.getElementById('savedScansList');
  if (!scans.length) {
    el.innerHTML = '<div class="empty-wallets">No saved scans yet. Run a scan and hit Save.</div>';
    return;
  }
  el.innerHTML = scans.map((s, i) => {
    const date  = new Date(s.savedAt).toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'2-digit' });
    const coins = s.coins.join(' × ');
    return `<div class="scan-item">
      <div class="scan-item-info">
        <div class="scan-item-name">${s.name}</div>
        <div class="scan-item-meta">${coins} &nbsp;·&nbsp; ${s.matchCount} wallets &nbsp;·&nbsp; ${date}</div>
      </div>
      <div class="scan-item-actions">
        <button class="load-btn" onclick="loadScanConfig(${i})">Load</button>
        <button class="remove-btn" onclick="confirmDeleteScan(${i})" title="Delete">×</button>
      </div>
    </div>`;
  }).join('');
}

async function loadScanConfig(index) {
  const snap = await getDoc(SCANS_COL);
  const scans = snap.exists() ? (snap.data().scans || []) : [];
  const scan  = scans[index];
  if (!scan) return;
  // Clear existing coins and repopulate
  document.getElementById('coinsList').innerHTML = '';
  coinCount = 0;
  scan.coins.forEach((label, i) => addCoin(label, scan.mints ? scan.mints[i] || '' : ''));
  switchTab('scan');
  // Scroll up to coins
  document.getElementById('coinsList').scrollIntoView({ behavior: 'smooth', block: 'center' });
}

let pendingDeleteIndex = null;

function confirmDeleteScan(index) {
  pendingDeleteIndex = index;
  document.getElementById('confirmOverlay').style.display = 'flex';
  document.getElementById('confirmYesBtn').onclick = executeDeleteScan;
}

function closeConfirm() {
  pendingDeleteIndex = null;
  document.getElementById('confirmOverlay').style.display = 'none';
}

async function executeDeleteScan() {
  closeConfirm();
  if (pendingDeleteIndex === null) return;
  const snap = await getDoc(SCANS_COL);
  const scans = snap.exists() ? (snap.data().scans || []) : [];
  scans.splice(pendingDeleteIndex, 1);
  await setDoc(SCANS_COL, { scans });
  renderSavedScans(scans);
  updateSavedTabCount(scans.length);
}

function updateSavedTabCount(n) {
  const el = document.getElementById('savedTabCount');
  if (el) el.textContent = n || '';
}
// ─────────────────────────────────────────────────────────────────────────────


// ── Historical Scan ───────────────────────────────────────────────────────────
async function fetchAllSignatures(mint, label) {
  const sigs = [];
  let before = undefined;
  let page   = 1;

  while (true) {
    const params = { jsonrpc:'2.0', id:'sigs', method:'getSignaturesForAddress',
      params: [mint, { limit: 1000, ...(before ? { before } : {}) }] };

    const resp = await fetch(HELIUS_RPC, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params)
    });
    const data = await resp.json();
    const batch = data?.result || [];
    if (!batch.length) break;

    batch.forEach(s => sigs.push(s.signature));
    before = batch[batch.length - 1].signature;
    setStatus(`[${label}] Fetching signatures — page ${page} (${sigs.length} total)`);
    page++;
    await new Promise(r => setTimeout(r, 100));
    if (batch.length < 1000) break;
  }
  return sigs;
}

async function fetchWalletsFromSignatures(sigs, mint, label) {
  const wallets = new Set();
  const BATCH   = 100;

  for (let i = 0; i < sigs.length; i += BATCH) {
    const batch = sigs.slice(i, i + BATCH);
    const params = { jsonrpc:'2.0', id:'txs', method:'getTransactions',
      params: [batch, { encoding:'jsonParsed', maxSupportedTransactionVersion: 0 }] };

    const resp = await fetch(HELIUS_RPC, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(params)
    });
    const data = await resp.json();
    const txs  = data?.result || [];

    for (const tx of txs) {
      if (!tx) continue;
      // Pull wallets from token balance changes for this mint
      const pre  = tx.meta?.preTokenBalances  || [];
      const post = tx.meta?.postTokenBalances || [];
      [...pre, ...post].forEach(b => {
        if (b.mint === mint && b.owner) {
          const w = b.owner;
          if (!BLACKLIST.has(w) && isOnCurve(w)) wallets.add(w);
        }
      });
    }

    setStatus(`[${label}] Parsing transactions ${Math.min(i+BATCH, sigs.length)}/${sigs.length} (${wallets.size} wallets found)`);
    await new Promise(r => setTimeout(r, 80));
  }

  return wallets;
}

async function runHistoricalScan() {
  clearError();
  const rows = document.querySelectorAll('.coin-row');
  const coins = [];
  for (const row of rows) {
    const inputs = row.querySelectorAll('input');
    const label  = inputs[0].value.trim();
    const mint   = inputs[1].value.trim();
    if (label && mint) coins.push({ label, mint });
  }

  if (coins.length < 2) return showError('Please enter at least 2 coins.');

  const maxResults = parseInt(document.getElementById('maxResults').value) || 100;

  document.getElementById('scanBtn').disabled  = true;
  document.getElementById('histBtn').disabled  = true;
  document.getElementById('results').classList.remove('visible');
  setStatus('Starting historical scan — this may take a while...');

  try {
    // Also fetch current holders for "still holding" flag
    const currentHolderSets = [];
    for (const { label, mint } of coins) {
      setStatus(`Fetching current holders for ${label}...`);
      const h = await fetchHolders(mint, label);
      currentHolderSets.push(new Set(Object.keys(h)));
    }

    // Now fetch full historical wallets
    const allHistorical = [];
    for (const { label, mint } of coins) {
      setStatus(`[${label}] Fetching ALL transaction signatures...`);
      const sigs    = await fetchAllSignatures(mint, label);
      setStatus(`[${label}] Got ${sigs.length} signatures, parsing wallets...`);
      const wallets = await fetchWalletsFromSignatures(sigs, mint, label);
      allHistorical.push(wallets);
    }

    setStatus('Finding historical overlap...');

    // Intersection of all historical wallet sets
    let common = new Set(allHistorical[0]);
    for (let i = 1; i < allHistorical.length; i++) {
      common = new Set([...common].filter(w => allHistorical[i].has(w)));
    }

    // Build results — check if still holding each coin
    const results = [];
    for (const wallet of common) {
      const stillHolding = coins.map((_, i) => currentHolderSets[i].has(wallet));
      results.push({
        wallet,
        label:        globalWallets[wallet] || '',
        amounts:      coins.map(() => null), // no balance for historical-only
        pcts:         coins.map(() => null),
        stillHolding,
        historical:   true,
      });
    }

    // Sort: still holding all coins first, then partial, then fully exited
    results.sort((a, b) => {
      const aScore = a.stillHolding.filter(Boolean).length;
      const bScore = b.stillHolding.filter(Boolean).length;
      return bScore - aScore;
    });

    lastResults = results;
    lastLabels  = coins.map(c => c.label);
    lastIsHistorical = true;

    clearStatus();
    renderResults(results.slice(0, maxResults), lastLabels, results.length, true);

  } catch (e) {
    clearStatus();
    showError(e.message || 'Historical scan failed.');
  }

  document.getElementById('scanBtn').disabled = false;
  document.getElementById('histBtn').disabled = false;
}
// ─────────────────────────────────────────────────────────────────────────────

// Expose to window for onclick handlers
window.checkPassword         = checkPassword;
window.runHistoricalScan     = runHistoricalScan;
window.addCoin            = addCoin;
window.removeCoin         = removeCoin;
window.runScan            = runScan;
window.exportCSV          = exportCSV;
window.saveScan           = saveScan;
window.switchTab          = switchTab;
window.addTrackedWallet   = addTrackedWallet;
window.removeWallet       = removeWallet;
window.loadScanConfig     = loadScanConfig;
window.confirmDeleteScan  = confirmDeleteScan;
window.closeConfirm       = closeConfirm;

// Init with 2 coins
addCoin();
addCoin();
</script>
</body>
</html>
